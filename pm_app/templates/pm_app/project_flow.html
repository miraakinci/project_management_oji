{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
    body {
        background-color: #f8f9fa; /* A light background for the whole page */
    }

    /* Main containers for the two sections */
    .page-section {
        background-color: #ffffff;
        padding: 2.5rem;
        margin-bottom: 2rem;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    /* Styles for the project flow (top section) */
    .flow-container {
        display: flex;
        align-items: stretch; /* Make cards equal height */
        justify-content: center;
        gap: 1.5rem;
        flex-wrap: wrap; /* Allow wrapping on smaller screens */
    }

    .flow-card {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 1.5rem;
        background-color: #f9f9f9;
        flex: 1; /* Allow cards to grow */
        min-width: 220px; /* Minimum width for each card */
        max-width: 280px; /* Maximum width for each card */
        display: flex;
        flex-direction: column;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .flow-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.08);
    }

    .flow-card h5 {
        color: #333;
        font-weight: bold;
        margin-bottom: 1rem;
    }

    .flow-card p, .flow-card div[data-name] {
        color: #555;
        background-color: #fff;
        padding: 0.75rem;
        border-radius: 4px;
        border: 1px dashed #ccc;
        flex-grow: 1;
        overflow-y: auto; /* Scroll inside the card if content is very long */
        max-height: 150px; /* Limit the height of the text area */
    }

    .flow-arrow {
        font-size: 2rem;
        color: #6c757d;
        align-self: center;
        display: none; /* Hide arrows on wrap */
    }

    @media (min-width: 1200px) {
        .flow-arrow {
            display: block; /* Show arrows on larger screens */
        }
    }


    /* Styles for the bottom plan section */
    .nav-tabs .nav-link {
        color: #495057;
    }

    .nav-tabs .nav-link.active {
        color: #007bff;
        border-color: #dee2e6 #dee2e6 #fff;
        font-weight: bold;
    }

    .tab-content {
        margin-top: 1.5rem;
    }

    .placeholder-content {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
        background-color: #f8f9fa;
        border-radius: 6px;
    }
</style>

<div class="container mt-5">

    <!-- =================================================================================== -->
    <!-- TOP SECTION: Project Flow                                                         -->
    <!-- =================================================================================== -->
    <div class="page-section">
        <h2 class="mb-3 text-center">1. Review & Refine Your Project Flow</h2>
        <p class="text-center text-muted mb-5">Click on any text to edit it, then confirm below to generate the detailed plan.</p>

        <form id="project-flow-form">
            <div class="flow-container text-center mb-4">
                <div class="card flow-card">
                    <h5 class="card-title">Vision</h5>
                    <p contenteditable="true" data-name="vision">{{ project.vision }}</p>
                </div>
                <div class="flow-arrow">&rarr;</div>
                <div class="card flow-card">
                    <h5 class="card-title">Outcomes</h5>
                    <div data-name="outcomes">
                    {% for item in project.outcomes.all %}
                        <p contenteditable="true">{{ item.description }}</p>
                    {% endfor %}
                    </div>
                </div>
                <div class="flow-arrow">&rarr;</div>
                <div class="card flow-card">
                    <h5 class="card-title">Benefits</h5>
                    <div data-name="benefits">
                    {% for item in project.benefits.all %}
                         <p contenteditable="true">{{ item.description }}</p>
                    {% endfor %}
                    </div>
                </div>
                 <div class="flow-arrow">&rarr;</div>
                <div class="card flow-card">
                    <h5 class="card-title">Deliverables</h5>
                    <div data-name="deliverables">
                    {% for item in project.deliverables.all %}
                         <p contenteditable="true">{{ item.description }}</p>
                    {% endfor %}
                    </div>
                </div>
            </div>

            <div class="text-center mt-4">
                <button type="submit" id="generate-plan-btn" class="btn btn-success btn-lg">Confirm & Generate Tasks</button>
            </div>
        </form>
    </div>

    <!-- =================================================================================== -->
    <!-- BOTTOM SECTION: Project Plan (Tasks, Gantt, etc.)                                 -->
    <!-- =================================================================================== -->
    <div class="page-section">
        <h2 class="mb-3">2. Project Plan</h2>
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tasks-tab" data-bs-toggle="tab" data-bs-target="#tasks" type="button" role="tab" aria-controls="tasks" aria-selected="true">Tasks</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="gantt-tab" data-bs-toggle="tab" data-bs-target="#gantt" type="button" role="tab" aria-controls="gantt" aria-selected="false">Gantt Chart</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="comms-tab" data-bs-toggle="tab" data-bs-target="#comms" type="button" role="tab" aria-controls="comms" aria-selected="false">Communication Channels</button>
            </li>
        </ul>
        <div class="tab-content" id="myTabContent">
            <!-- Tasks Tab Pane -->
            <div class="tab-pane fade show active" id="tasks" role="tabpanel" aria-labelledby="tasks-tab">
                <table class="table table-striped table-hover">
                    <thead class="thead-dark">
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">Task Name</th>
                            <th scope="col">Assigned To</th>
                            <th scope="col">Duration</th>
                        </tr>
                    </thead>
                    <tbody id="tasks-table-body">
                        <tr class="placeholder-row">
                            <td colspan="5" class="text-center p-5">Confirm the project flow above to generate a list of tasks.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <!-- Gantt Chart Tab Pane -->
            <div class="tab-pane fade" id="gantt" role="tabpanel" aria-labelledby="gantt-tab">
                <div class="placeholder-content">
                    <p>The Gantt Chart will be generated here once tasks are created.</p>
                </div>
            </div>
            <!-- Communication Channels Tab Pane -->
            <div class="tab-pane fade" id="comms" role="tabpanel" aria-labelledby="comms-tab">
                 <div class="placeholder-content">
                    <p>A summary of communication channels will be displayed here.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const projectFlowForm = document.getElementById('project-flow-form');
    const tasksTableBody = document.getElementById('tasks-table-body');

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    projectFlowForm.addEventListener('submit', function(event) {
        event.preventDefault(); 

        tasksTableBody.innerHTML = '<tr><td colspan="5" class="text-center p-5">Generating tasks... <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span></td></tr>';

        const data = {
            vision: document.querySelector('[data-name="vision"]').innerText,
            outcomes: Array.from(document.querySelectorAll('[data-name="outcomes"] p')).map(p => p.innerText),
            benefits: Array.from(document.querySelectorAll('[data-name="benefits"] p')).map(p => p.innerText),
            deliverables: Array.from(document.querySelectorAll('[data-name="deliverables"] p')).map(p => p.innerText),
        };

        fetch("{% url 'generate_tasks_ajax' project_id=project.id %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(err.message || 'Server error'); });
            }
            return response.json();
        })
        .then(result => {
            tasksTableBody.innerHTML = ''; 
            if (result.tasks && result.tasks.length > 0) {
                result.tasks.forEach((task, index) => {
                    const row = `
                        <tr>
                            <th scope="row">${index + 1}</th>
                            <td>${task.name}</td>
                            <td>${task.assigned_to}</td>
                            <td>${task.duration}</td>
                        </tr>
                    `;
                    tasksTableBody.innerHTML += row;
                });
            } else {
                tasksTableBody.innerHTML = '<tr><td colspan="5" class="text-center p-5">No tasks were generated. Please refine your project flow and try again.</td></tr>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            tasksTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger p-5">An error occurred: ${error.message}</td></tr>`;
        });
    });
});
</script>

{% endblock %}
