{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
    body {
        background-color: #f8f9fa; /* A light background for the whole page */
    }

    /* Main containers for the two sections */
    .page-section {
        background-color: #ffffff;
        padding: 2.5rem;
        margin-bottom: 2rem;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    /* Styles for the project flow (top section) */
    .flow-container {
        display: flex;
        flex-wrap: nowrap;
        gap: 1.5rem; /* Space between cards */
        align-items: flex-start; /* Align cards to the top */
        overflow-x: auto; /* Allow horizontal scrolling */
        padding-bottom: 4px;
    }

    .flow-card {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 1.5rem;
        background-color: #f9f9f9;
        flex: 0 0 320px; /* Prevent shrinking, set base width */
        min-width: 320px; /* Minimum width for each card */
        display: flex;
        flex-direction: column;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .flow-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.08);
    }

    .flow-card h5 {
        color: #333;
        font-weight: bold;
        margin-bottom: 1rem;
    }

    .flow-card p, .flow-card div[data-name] {
        color: #555;
        background-color: #fff;
        padding: 0.75rem;
        border-radius: 4px;
        border: 1px dashed #ccc;
        flex-grow: 1;
        overflow-y: visible;
        min-height: 200px;
    }
    
    /* ADDED: Add some spacing between wrapped items in Benefits/Deliverables */
    .flow-card [data-id] {
        border: 1px dashed #ddd;
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        border-radius: 4px;
        background-color: #fff;
    }

    /* Styles for the bottom plan section */
    .nav-tabs .nav-link {
        color: #495057;
    }

    .nav-tabs .nav-link.active {
        color: #007bff;
        border-color: #dee2e6 #dee2e6 #fff;
        font-weight: bold;
    }

    .tab-content {
        margin-top: 1.5rem;
    }

    .placeholder-content {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
        background-color: #f8f9fa;
        border-radius: 6px;
    }

    /* Loading overlay styles */
    #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.85); /* Semi-transparent white background */
        z-index: 1050; /* High z-index to be on top */
        display: none; /* Hidden by default */
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }

    .spinner {
        border: 8px solid #e9ecef; /* Light grey */
        border-top: 8px solid #007bff; /* Primary blue */
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1.5s linear infinite;
    }

    #loading-overlay p {
        margin-top: 20px;
        font-size: 1.2rem;
        color: #343a40;
        font-weight: 500;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>

<div class="container mt-5">

    <div class="page-section">
        <h2 class="mb-3 text-center">1. Review & Refine Your Project Flow</h2>
        <p class="text-center text-muted mb-5">Click on any text to edit it, then confirm below to generate the detailed plan.</p>

        <form id="project-flow-form">
            <div class="flow-container text-center mb-4">
                <div class="card flow-card">
                    <h5 class="card-title">Vision</h5>
                    <p contenteditable="true" data-name="vision">{{ project.vision }}</p>
                    <button type="button" class="edit-btn">Edit</button>
                    <button type="button" class="done-btn" style="display:none;">Done</button>
                </div>
                <div class="card flow-card">
                    <h5 class="card-title">Outcomes</h5>
                    <div id="outcomes-container" data-name="outcomes">
                        {% for outcome in outcomes %}
                            <div class="outcome-item" data-id="{{ outcome.id }}">
                                <p class="description" contenteditable="true">{{ outcome.description }}</p>
                                <button type="button" class="edit-btn">Edit</button>
                                <button type="button" class="done-btn" style="display:none;">Done</button>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="card flow-card">
                    <h5 class="card-title">Benefits</h5>
                    <div data-name="benefits">
                        {% for outcome in outcomes %}
                            {% for benefit in outcome.benefits.all %}
                                <div data-id="{{ benefit.id }}">
                                    <p contenteditable="true">{{ benefit.description }}</p>
                                    <button type="button" class="edit-btn">Edit</button>
                                    <button type="button" class="done-btn" style="display:none;">Done</button>
                                </div>
                            {% endfor %}
                        {% endfor %}
                    </div>
                </div>
                <div class="card flow-card">
                    <h5 class="card-title">Deliverables</h5>
                    <div data-name="deliverables">
                        {% for outcome in outcomes %}
                            {% for benefit in outcome.benefits.all %}
                                {% for deliverable in benefit.deliverables.all %}
                                    <div data-id="{{ deliverable.id }}">
                                        <p contenteditable="true">{{ deliverable.description }}</p>
                                        <button type="button" class="edit-btn">Edit</button>
                                        <button type="button" class="done-btn" style="display:none;">Done</button>
                                    </div>
                                {% endfor %}
                            {% endfor %}
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="text-center mt-4">
                <p class="text-center text-muted mb-5">Click on any text to edit it; tasks update automatically below.</p>
            </div>
        </form>
    </div>

    <div class="page-section">
        <h2 class="mb-3">2. Project Plan</h2>
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tasks-tab" data-bs-toggle="tab" data-bs-target="#tasks" type="button" role="tab" aria-controls="tasks" aria-selected="true">Tasks</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="gantt-tab" data-bs-toggle="tab" data-bs-target="#gantt" type="button" role="tab" aria-controls="gantt" aria-selected="false">Gantt Chart</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="comms-tab" data-bs-toggle="tab" data-bs-target="#comms" type="button" role="tab" aria-controls="comms" aria-selected="false">Communication Channels</button>
            </li>
        </ul>
        <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active" id="tasks" role="tabpanel" aria-labelledby="tasks-tab">
                <table class="table table-striped table-hover">
                    <thead class="thead-dark">
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">Task Name</th>
                            <th scope="col">Responsible Team</th>
                            <th scope="col">Duration</th>
                        </tr>
                    </thead>
                    <tbody id="tasks-table-body">
                        {% with has_tasks=False %}
                            {% for outcome in outcomes %}
                                {% for benefit in outcome.benefits.all %}
                                    {% for deliverable in benefit.deliverables.all %}
                                        {% for task in deliverable.tasks.all %}
                                            {% if not has_tasks %}{% with has_tasks=True %}{% endwith %}{% endif %}
                                            <tr>
                                                <td>{{ forloop.parentloop.parentloop.parentloop.counter }}.{{ forloop.parentloop.parentloop.counter }}.{{ forloop.parentloop.counter }}.{{ forloop.counter }}</td>
                                                <td>{{ task.name }}</td>
                                                <td>{{ task.responsible_team }}</td>
                                                <td>{{ task.duration }}</td>
                                            </tr>
                                        {% endfor %}
                                    {% endfor %}
                                {% endfor %}
                            {% endfor %}
                            {% if not has_tasks %}
                                <tr class="placeholder-row">
                                    <td colspan="4" class="text-center p-5">Editing the flow above will automatically generate tasks.</td>
                                </tr>
                            {% endif %}
                        {% endwith %}
                    </tbody>
                </table>
            </div>
            <div class="tab-pane fade" id="gantt" role="tabpanel" aria-labelledby="gantt-tab">
                <div class="placeholder-content">
                    <p>The Gantt Chart will be generated here once tasks are created.</p>
                </div>
            </div>
            <div class="tab-pane fade" id="comms" role="tabpanel" aria-labelledby="comms-tab">
                 <div class="placeholder-content">
                    <p>A summary of communication channels will be displayed here.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="loading-overlay">
    <div class="spinner"></div>
    <p>Processing changes...</p>
</div>

<script>
const csrftoken = (() => {
  // Function to get the CSRF token from cookies
  let v = null;
  document.cookie.split(';').forEach(c => {
    c = c.trim();
    if (c.startsWith('csrftoken=')) v = decodeURIComponent(c.slice('csrftoken='.length));
  });
  return v;
})();

async function sendUpdate(field, payload) {
  // Show the loading overlay before sending the request
  document.getElementById('loading-overlay').style.display = 'flex';

  try {
    const body = { edited_field: field, payload: payload, source_of_change: 'user' };
    const resp = await fetch("{% url 'update_flow_ajax' project_id=project.id %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken
      },
      body: JSON.stringify(body)
    });

    // Check if the server responded with an error status
    if (!resp.ok) {
        throw new Error(`Server responded with status: ${resp.status}`);
    }

    const result = await resp.json();
    if (result.status === 'success') {
      // Reload after successful edit. The overlay will disappear on page reload.
      window.location.reload();
    } else {
      // Handle application-level errors (e.g., validation failure)
      console.error('Update failed:', result);
      // Hide the overlay and show an error message
      document.getElementById('loading-overlay').style.display = 'none';
    }
  } catch (error) {
    // Handle network errors or other exceptions during the fetch
    console.error('Error during fetch:', error);
    // Hide the overlay and show an error message
    document.getElementById('loading-overlay').style.display = 'none';
  }
}

function collectPayload(field, item) {
    if (field === 'vision') {
        return { vision: item.innerText.trim() };
    } else {
        const payload = {
            id: item.closest('[data-id]').getAttribute('data-id'),
            description: item.innerText.trim()
        };
        return payload;
    }
}

// Use event delegation to handle clicks on the entire document
document.addEventListener('click', e => {
  // Case 1: An "Edit" button was clicked
  if (e.target.matches('.edit-btn')) {
    const item = e.target.closest('[data-id]') || e.target.closest('.flow-card');
    const editable = item.querySelector('[contenteditable]');
    if (editable) {
        editable.setAttribute('contenteditable', 'true');
        editable.focus(); // Focus the element for immediate editing
    }
    e.target.style.display = 'none'; // Hide the edit button
    const doneBtn = item.querySelector('.done-btn');
    if (doneBtn) doneBtn.style.display = 'inline-block'; // Show the done button
    return;
  }

  // Case 2: A "Done" button was clicked
  if (e.target.matches('.done-btn')) {
    const doneBtn = e.target;
    const item = doneBtn.closest('[data-id]') || doneBtn.closest('.flow-card');

    // Determine which field is being edited
    let field = item.getAttribute('data-name');
    if (!field) { // This handles cases like outcomes/benefits where data-name is on a parent container
        const parentCard = item.closest('.flow-card');
        if (parentCard) {
            const dataNameElement = parentCard.querySelector('[data-name]');
            if (dataNameElement) {
                field = dataNameElement.getAttribute('data-name');
            }
        }
    }
    
    // Make the element non-editable again
    const editable = item.querySelector('[contenteditable]');
    if (editable) editable.setAttribute('contenteditable', 'false');

    // Swap the "Done" button back to an "Edit" button
    const editBtn = item.querySelector('.edit-btn');
    if (editBtn) editBtn.style.display = 'inline-block';
    doneBtn.style.display = 'none';

    // Collect the data and send the update
    const payload = collectPayload(field, editable);
    sendUpdate(field, payload);
    return;
  }

  // Case 3: A "Delete" button was clicked (for outcomes)
  if (e.target.matches('.delete-btn')) {
    const outcomeItem = e.target.closest('.outcome-item');
    if (outcomeItem) {
      outcomeItem.remove(); // Remove the item from the DOM
      const payload = collectPayload('outcomes'); // Recalculate the outcomes
      sendUpdate('outcomes', payload); // Send the update to the server
    }
  }
});
</script>

{% endblock %}